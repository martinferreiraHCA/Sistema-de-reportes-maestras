<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <base target="_top">
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      padding: 20px;
      max-width: 800px;
      margin: 0 auto;
      background: #f5f5f5;
    }
    .container {
      background: white;
      padding: 25px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    h2 {
      color: #1a73e8;
      border-bottom: 2px solid #1a73e8;
      padding-bottom: 10px;
    }
    h3 {
      color: #5f6368;
      margin-top: 20px;
      font-size: 1.1em;
    }
    label {
      font-weight: bold;
      margin-top: 10px;
      display: block;
      color: #333;
    }
    select, textarea, input {
      width: 100%;
      padding: 8px;
      margin-top: 4px;
      border: 1px solid #dadce0;
      border-radius: 4px;
      font-size: 14px;
      box-sizing: border-box;
    }
    textarea {
      min-height: 80px;
      font-family: inherit;
      resize: vertical;
    }
    button {
      margin-top: 15px;
      padding: 10px 20px;
      cursor: pointer;
      border: none;
      border-radius: 4px;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.3s;
    }
    button.primary {
      background: #1a73e8;
      color: white;
    }
    button.primary:hover {
      background: #1557b0;
    }
    button.secondary {
      background: #f1f3f4;
      color: #5f6368;
    }
    button.secondary:hover {
      background: #e8eaed;
    }
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .status {
      margin-top: 15px;
      padding: 10px;
      border-radius: 4px;
      display: none;
    }
    .status.success {
      background: #e6f4ea;
      color: #137333;
      display: block;
    }
    .status.error {
      background: #fce8e6;
      color: #c5221f;
      display: block;
    }
    .status.info {
      background: #e8f0fe;
      color: #1967d2;
      display: block;
    }
    .api-config {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 4px;
      margin-bottom: 20px;
    }
    .api-status {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 500;
    }
    .api-status.configured {
      background: #e6f4ea;
      color: #137333;
    }
    .api-status.not-configured {
      background: #fce8e6;
      color: #c5221f;
    }
    .loading {
      display: inline-block;
      border: 2px solid #f3f3f3;
      border-top: 2px solid #1a73e8;
      border-radius: 50%;
      width: 16px;
      height: 16px;
      animation: spin 1s linear infinite;
      margin-left: 10px;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .section {
      margin-bottom: 20px;
    }
    .provider-info {
      font-size: 12px;
      color: #666;
      margin-top: 5px;
      padding: 8px;
      background: #f8f9fa;
      border-radius: 4px;
    }
    .model-hint {
      font-size: 11px;
      color: #666;
      margin: 4px 0;
    }
  </style>
</head>
<body>

<div class="container">
  <h2>üéì Generador de Informe de Actuaci√≥n Docente</h2>

  <!-- Configuraci√≥n de IA Multi-Proveedor -->
  <div class="api-config section">
    <h3>‚öôÔ∏è Configuraci√≥n de IA</h3>
    <p style="font-size: 14px; color: #5f6368; margin: 5px 0;">
      Estado: <span id="apiStatus" class="api-status not-configured">No configurada</span>
    </p>

    <label>Proveedor de IA</label>
    <select id="proveedor">
      <option value="gemini">Google Gemini (Gratis con l√≠mites)</option>
      <option value="openai">OpenAI GPT (Requiere cuenta de pago)</option>
      <option value="claude">Anthropic Claude (Requiere cuenta de pago)</option>
      <option value="deepseek">DeepSeek (Requiere cuenta de pago)</option>
    </select>

    <label style="margin-top: 15px;">Modelo</label>
    <select id="modeloIA">
      <!-- Se llenar√° din√°micamente seg√∫n el proveedor -->
    </select>
    <p class="model-hint" id="modelHint"></p>
    <button class="secondary" id="btnListarModelos" style="margin-top: 4px;">
      üîç Listar Modelos Disponibles
    </button>
    <p style="font-size: 11px; color: #666; margin: 4px 0;">
      üí° Consulta los modelos reales disponibles para tu cuenta
    </p>

    <label>API Key</label>
    <input type="password" id="apiKey" placeholder="Ingresa tu API Key">
    <div class="provider-info" id="providerInfo"></div>

    <div style="margin-top: 8px;">
      <button class="secondary" id="btnGuardarApi">Guardar Configuraci√≥n</button>
      <button class="secondary" id="btnProbarApi">Probar Conexi√≥n</button>
    </div>
    <p id="estadoApi" class="status"></p>
  </div>

  <hr style="border: none; border-top: 1px solid #dadce0; margin: 20px 0;">

  <h3>üìã Datos del Informe</h3>

  <div class="section">
    <label>Nivel</label>
    <select id="nivel">
      <option value="inicial">Educaci√≥n Inicial</option>
      <option value="primaria">Primaria</option>
    </select>

    <label>Docente</label>
    <select id="docente">
      <option value="">Selecciona un nivel...</option>
    </select>

    <label>Grupo (opcional)</label>
    <input id="grupo" placeholder="Ej: 5¬∞ A">
  </div>

  <div class="section">
    <h3>üí™ Fortalezas del Docente</h3>
    <textarea id="fortalezas" placeholder="Describe las principales fortalezas observadas..."></textarea>

    <label style="margin-top: 15px;">‚ö†Ô∏è Aspectos a mejorar</label>
    <textarea id="mejoras" placeholder="Describe los aspectos que el docente puede mejorar..."></textarea>

    <label>üìù Informaci√≥n adicional</label>
    <textarea id="infoExtra" placeholder="Cualquier contexto adicional relevante para el informe..."></textarea>
  </div>

  <button id="generar" class="primary">‚ú® Generar Informe con IA</button>

  <p id="estado" class="status"></p>
</div>

<script>
// Configuraci√≥n de modelos por proveedor
const MODELOS = {
  gemini: [
    { value: "gemini-2.0-flash-exp", label: "Gemini 2.0 Flash Exp ‚ö° (M√°s r√°pido, experimental)" },
    { value: "gemini-1.5-flash", label: "Gemini 1.5 Flash (R√°pido y eficiente)" },
    { value: "gemini-1.5-pro", label: "Gemini 1.5 Pro (Mayor calidad)" }
  ],
  openai: [
    { value: "gpt-4o-mini", label: "GPT-4o Mini ‚ö° (R√°pido y econ√≥mico)" },
    { value: "gpt-4o", label: "GPT-4o (Mejor calidad)" },
    { value: "gpt-4-turbo", label: "GPT-4 Turbo (Alta calidad)" }
  ],
  claude: [
    { value: "claude-3-5-sonnet-20241022", label: "Claude 3.5 Sonnet (Recomendado)" },
    { value: "claude-3-5-haiku-20241022", label: "Claude 3.5 Haiku ‚ö° (M√°s r√°pido)" },
    { value: "claude-3-opus-20240229", label: "Claude 3 Opus (M√°xima calidad)" }
  ],
  deepseek: [
    { value: "deepseek-chat", label: "DeepSeek Chat (Modelo general)" },
    { value: "deepseek-coder", label: "DeepSeek Coder (Especializado en c√≥digo)" }
  ]
};

const PROVIDER_INFO = {
  gemini: {
    url: "https://makersuite.google.com/app/apikey",
    text: "Obt√©n tu API Key gratis en Google AI Studio. Tiene l√≠mites generosos para uso personal."
  },
  openai: {
    url: "https://platform.openai.com/api-keys",
    text: "Requiere cuenta con cr√©ditos. Crea tu API Key en la plataforma de OpenAI."
  },
  claude: {
    url: "https://console.anthropic.com/settings/keys",
    text: "Requiere cuenta con cr√©ditos. Crea tu API Key en Anthropic Console."
  },
  deepseek: {
    url: "https://platform.deepseek.com/api_keys",
    text: "Requiere cuenta con cr√©ditos. Crea tu API Key en DeepSeek Platform. Modelos potentes y econ√≥micos."
  }
};

// Inicializaci√≥n
window.onload = function() {
  verificarEstadoApi();
  cargarDocentes();
  actualizarProveedor();

  // Event listener para cambio de proveedor
  document.getElementById("proveedor").addEventListener("change", actualizarProveedor);

  // Event listener para cambio de modelo - guardar autom√°ticamente
  document.getElementById("modeloIA").addEventListener("change", function() {
    const modelo = this.value;
    if (modelo) {
      google.script.run
        .withSuccessHandler(function() {
          console.log("Modelo guardado:", modelo);
          mostrarEstado("estadoApi", `‚úÖ Modelo actualizado: ${modelo}`, "success");
        })
        .withFailureHandler(function(err) {
          console.error("Error guardando modelo:", err);
          mostrarEstado("estadoApi", "‚ùå Error guardando modelo: " + err.message, "error");
        })
        .guardarModelo(modelo);
    }
  });
};

// Actualizar modelos y info seg√∫n proveedor seleccionado
function actualizarProveedor() {
  const proveedor = document.getElementById("proveedor").value;
  const modeloSelect = document.getElementById("modeloIA");
  const providerInfoDiv = document.getElementById("providerInfo");
  const modelHint = document.getElementById("modelHint");

  // Intentar cargar modelos guardados del sessionStorage
  const modelosGuardados = sessionStorage.getItem(`modelos_${proveedor}`);

  modeloSelect.innerHTML = "";

  if (modelosGuardados) {
    // Usar modelos consultados previamente
    const modelos = JSON.parse(modelosGuardados);
    modelos.forEach(m => {
      const opt = document.createElement("option");
      opt.value = m.id;
      opt.textContent = m.nombre;
      modeloSelect.appendChild(opt);
    });
    modelHint.textContent = `‚úÖ Usando ${modelos.length} modelos consultados previamente`;
  } else {
    // Usar modelos por defecto
    MODELOS[proveedor].forEach(m => {
      const opt = document.createElement("option");
      opt.value = m.value;
      opt.textContent = m.label;
      modeloSelect.appendChild(opt);
    });

    // Hints de modelos
    const hints = {
      gemini: "üí° Flash = R√°pido | Pro = Mayor calidad",
      openai: "üí° Mini = Econ√≥mico | 4o = Mejor balance | Turbo = M√°xima calidad",
      claude: "üí° Haiku = R√°pido | Sonnet = Balance | Opus = M√°xima calidad",
      deepseek: "üí° Chat = Uso general | Coder = Especializado en c√≥digo"
    };
    modelHint.textContent = hints[proveedor] + " | üîç Haz clic en 'Listar Modelos' para ver todos";
  }

  // Actualizar informaci√≥n del proveedor
  const info = PROVIDER_INFO[proveedor];
  providerInfoDiv.innerHTML = `
    üí° ${info.text}<br>
    üìù <a href="${info.url}" target="_blank">Obtener API Key aqu√≠</a>
  `;

  // Guardar proveedor seleccionado
  google.script.run
    .withFailureHandler(function(err) {
      console.error("Error guardando proveedor:", err);
    })
    .guardarProveedor(proveedor);

  // Guardar el primer modelo seleccionado autom√°ticamente
  setTimeout(function() {
    const primerModelo = modeloSelect.value;
    if (primerModelo) {
      google.script.run
        .withFailureHandler(function(err) {
          console.error("Error guardando modelo inicial:", err);
        })
        .guardarModelo(primerModelo);
    }
  }, 100);
}

// Verificar estado de API
function verificarEstadoApi() {
  google.script.run
    .withSuccessHandler(function(result) {
      const statusEl = document.getElementById("apiStatus");
      if (result.configurada) {
        statusEl.textContent = `‚úÖ ${result.proveedor.toUpperCase()} configurado ${result.keyParcial || ""}`;
        statusEl.className = "api-status configured";
      } else {
        statusEl.textContent = "‚ùå No configurada";
        statusEl.className = "api-status not-configured";
      }
    })
    .withFailureHandler(function(err) {
      mostrarEstado("estadoApi", "Error al verificar API: " + err.message, "error");
    })
    .verificarApiKey();
}

function mostrarEstado(elementId, mensaje, tipo) {
  const el = document.getElementById(elementId);
  el.textContent = mensaje;
  el.className = "status " + tipo;
  setTimeout(() => {
    el.className = "status";
  }, 5000);
}

// Guardar configuraci√≥n
document.getElementById("btnGuardarApi").onclick = function() {
  const apiKey = document.getElementById("apiKey").value.trim();
  const modelo = document.getElementById("modeloIA").value;
  const proveedor = document.getElementById("proveedor").value;

  if (!apiKey) {
    mostrarEstado("estadoApi", "Por favor ingresa una API Key", "error");
    return;
  }

  mostrarEstado("estadoApi", "Guardando configuraci√≥n...", "info");

  // Guardar proveedor primero
  google.script.run
    .withSuccessHandler(function() {
      // Luego API Key
      google.script.run
        .withSuccessHandler(function() {
          // Luego modelo
          google.script.run
            .withSuccessHandler(function() {
              mostrarEstado("estadoApi", "‚úÖ Configuraci√≥n guardada correctamente", "success");
              document.getElementById("apiKey").value = "";
              verificarEstadoApi();
            })
            .withFailureHandler(function(err) {
              mostrarEstado("estadoApi", "Error: " + err.message, "error");
            })
            .guardarModelo(modelo);
        })
        .withFailureHandler(function(err) {
          mostrarEstado("estadoApi", "Error: " + err.message, "error");
        })
        .guardarApiKey(apiKey);
    })
    .withFailureHandler(function(err) {
      mostrarEstado("estadoApi", "Error: " + err.message, "error");
    })
    .guardarProveedor(proveedor);
};

// Probar conexi√≥n
document.getElementById("btnProbarApi").onclick = function() {
  mostrarEstado("estadoApi", "Probando conexi√≥n...", "info");

  google.script.run
    .withSuccessHandler(function(result) {
      mostrarEstado("estadoApi", "‚úÖ " + result.message, "success");
    })
    .withFailureHandler(function(err) {
      mostrarEstado("estadoApi", "‚ùå " + err.message, "error");
    })
    .probarConexion();
};

// Listar modelos disponibles
document.getElementById("btnListarModelos").onclick = function() {
  const proveedor = document.getElementById("proveedor").value;
  const btn = this;

  btn.disabled = true;
  btn.textContent = "‚è≥ Consultando...";
  mostrarEstado("estadoApi", "Consultando modelos disponibles...", "info");

  google.script.run
    .withSuccessHandler(function(result) {
      btn.disabled = false;
      btn.textContent = "üîç Listar Modelos Disponibles";

      if (result.success && result.modelos && result.modelos.length > 0) {
        // Llenar dropdown con modelos reales
        const modeloSelect = document.getElementById("modeloIA");
        modeloSelect.innerHTML = "";

        result.modelos.forEach(m => {
          const opt = document.createElement("option");
          opt.value = m.id;
          opt.textContent = m.nombre;
          modeloSelect.appendChild(opt);
        });

        // Guardar en sessionStorage
        sessionStorage.setItem(`modelos_${proveedor}`, JSON.stringify(result.modelos));

        // Guardar autom√°ticamente el primer modelo seleccionado
        if (modeloSelect.value) {
          google.script.run
            .withFailureHandler(function(err) {
              console.error("Error guardando modelo:", err);
            })
            .guardarModelo(modeloSelect.value);
        }

        let mensaje = `‚úÖ Se encontraron ${result.modelos.length} modelos disponibles`;
        if (result.nota) {
          mensaje += `\n${result.nota}`;
        }
        mostrarEstado("estadoApi", mensaje, "success");
      } else {
        mostrarEstado("estadoApi", "No se encontraron modelos", "error");
      }
    })
    .withFailureHandler(function(err) {
      btn.disabled = false;
      btn.textContent = "üîç Listar Modelos Disponibles";
      mostrarEstado("estadoApi", "‚ùå " + err.message + "\nüí° Aseg√∫rate de haber guardado tu API Key primero", "error");
    })
    .listarModelosDisponibles();
};

// Cargar docentes
function cargarDocentes() {
  const nivel = document.getElementById("nivel").value;
  const sel = document.getElementById("docente");
  sel.innerHTML = "<option>Cargando...</option>";

  google.script.run
    .withSuccessHandler(function(lista) {
      sel.innerHTML = "<option value=''>Seleccionar...</option>";
      lista.forEach(d => {
        const opt = document.createElement("option");
        opt.value = d.nombre;
        opt.textContent = d.nombre + " ‚Äî " + d.clase;
        sel.appendChild(opt);
      });
    })
    .withFailureHandler(function(err) {
      sel.innerHTML = "<option value=''>Error al cargar</option>";
      mostrarEstado("estado", "Error al cargar docentes: " + err.message, "error");
    })
    .getDocentes(nivel);
}

document.getElementById("nivel").addEventListener("change", cargarDocentes);

// Generar informe
document.getElementById("generar").onclick = function() {
  const nombreDocente = document.getElementById("docente").value;

  if (!nombreDocente) {
    mostrarEstado("estado", "Por favor selecciona un docente", "error");
    return;
  }

  const params = {
    nivel: document.getElementById("nivel").value,
    nombreDocente: nombreDocente,
    grupo: document.getElementById("grupo").value,
    fortalezas: document.getElementById("fortalezas").value,
    mejoras: document.getElementById("mejoras").value,
    infoExtra: document.getElementById("infoExtra").value
  };

  const btnGenerar = document.getElementById("generar");
  btnGenerar.disabled = true;
  btnGenerar.innerHTML = '‚è≥ Generando con IA<span class="loading"></span>';

  const estadoEl = document.getElementById("estado");
  estadoEl.className = "status info";
  estadoEl.textContent = "ü§ñ La IA est√° generando las observaciones personalizadas...";

  google.script.run
    .withSuccessHandler(function(res) {
      btnGenerar.disabled = false;
      btnGenerar.innerHTML = "‚ú® Generar Informe con IA";

      estadoEl.className = "status success";
      estadoEl.innerHTML = `
        ‚úÖ <strong>¬°Informe generado exitosamente!</strong><br>
        <a href="${res.url}" target="_blank" style="color: #137333; font-weight: bold;">
          üìÑ Abrir informe en Google Docs
        </a>
      `;
    })
    .withFailureHandler(function(err) {
      btnGenerar.disabled = false;
      btnGenerar.innerHTML = "‚ú® Generar Informe con IA";

      estadoEl.className = "status error";
      estadoEl.innerHTML = `
        <strong>‚ùå Error:</strong> ${err.message}<br>
        <small>Si el error persiste, intenta con otro proveedor de IA.</small>
      `;
    })
    .generarInforme(params);
};
</script>

</body>
</html>
