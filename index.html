<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <base target="_top">
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      padding: 20px;
      max-width: 800px;
      margin: 0 auto;
      background: #f5f5f5;
    }
    .container {
      background: white;
      padding: 25px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    h2 {
      color: #1a73e8;
      border-bottom: 2px solid #1a73e8;
      padding-bottom: 10px;
    }
    h3 {
      color: #5f6368;
      margin-top: 20px;
      font-size: 1.1em;
    }
    label {
      font-weight: bold;
      margin-top: 10px;
      display: block;
      color: #333;
    }
    select, textarea, input {
      width: 100%;
      padding: 8px;
      margin-top: 4px;
      border: 1px solid #dadce0;
      border-radius: 4px;
      font-size: 14px;
      box-sizing: border-box;
    }
    textarea {
      min-height: 80px;
      font-family: inherit;
      resize: vertical;
    }
    button {
      margin-top: 15px;
      padding: 10px 20px;
      cursor: pointer;
      border: none;
      border-radius: 4px;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.3s;
    }
    button.primary {
      background: #1a73e8;
      color: white;
    }
    button.primary:hover {
      background: #1557b0;
    }
    button.secondary {
      background: #f1f3f4;
      color: #5f6368;
    }
    button.secondary:hover {
      background: #e8eaed;
    }
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .status {
      margin-top: 15px;
      padding: 10px;
      border-radius: 4px;
      display: none;
    }
    .status.success {
      background: #e6f4ea;
      color: #137333;
      display: block;
    }
    .status.error {
      background: #fce8e6;
      color: #c5221f;
      display: block;
    }
    .status.info {
      background: #e8f0fe;
      color: #1967d2;
      display: block;
    }
    .api-config {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 4px;
      margin-bottom: 20px;
    }
    .api-status {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 500;
    }
    .api-status.configured {
      background: #e6f4ea;
      color: #137333;
    }
    .api-status.not-configured {
      background: #fce8e6;
      color: #c5221f;
    }
    .loading {
      display: inline-block;
      border: 2px solid #f3f3f3;
      border-top: 2px solid #1a73e8;
      border-radius: 50%;
      width: 16px;
      height: 16px;
      animation: spin 1s linear infinite;
      margin-left: 10px;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .section {
      margin-bottom: 20px;
    }
  </style>
</head>
<body>

<div class="container">
  <h2>üéì Generador de Informe de Actuaci√≥n Docente</h2>

  <!-- Configuraci√≥n de API -->
  <div class="api-config section">
    <h3>‚öôÔ∏è Configuraci√≥n de Google AI (Gemini)</h3>
    <p style="font-size: 14px; color: #5f6368; margin: 5px 0;">
      Estado: <span id="apiStatus" class="api-status not-configured">No configurada</span>
    </p>
    <label>API Key de Gemini</label>
    <input type="password" id="apiKey" placeholder="Ingresa tu API Key de Gemini">

    <label style="margin-top: 15px;">Modelo de IA</label>
    <select id="modeloIA">
      <option value="gemini-2.5-flash">Gemini 2.5 Flash ‚ö° (Recomendado - R√°pido y eficiente)</option>
      <option value="gemini-2.5-pro">Gemini 2.5 Pro üèÜ (Mejor calidad, m√°s lento)</option>
      <option value="gemini-flash-latest">Gemini Flash Latest (Versi√≥n estable m√°s reciente)</option>
      <option value="gemini-pro-latest">Gemini Pro Latest (M√°xima calidad estable)</option>
      <option value="gemini-2.0-flash">Gemini 2.0 Flash (Versi√≥n anterior r√°pida)</option>
    </select>
    <p style="font-size: 11px; color: #666; margin: 4px 0;">
      üí° <strong>Flash</strong> = R√°pido y econ√≥mico | <strong>Pro</strong> = Mayor calidad y razonamiento
    </p>

    <div style="margin-top: 8px;">
      <button class="secondary" id="btnGuardarApi">Guardar Configuraci√≥n</button>
      <button class="secondary" id="btnProbarApi">Probar Conexi√≥n</button>
    </div>
    <p id="estadoApi" class="status"></p>
    <p style="font-size: 12px; color: #5f6368; margin-top: 10px;">
      üìù Obt√©n tu API Key gratis en: <a href="https://makersuite.google.com/app/apikey" target="_blank">Google AI Studio</a>
    </p>
  </div>

  <hr style="border: none; border-top: 1px solid #dadce0; margin: 20px 0;">

  <h3>üìã Datos del Informe</h3>

  <div class="section">
    <label>Nivel</label>
    <select id="nivel">
      <option value="inicial">Educaci√≥n Inicial</option>
      <option value="primaria">Primaria</option>
    </select>

    <label>Docente</label>
    <select id="docente">
      <option value="">Selecciona un nivel...</option>
    </select>

    <label>Grupo (opcional)</label>
    <input id="grupo" placeholder="Ej: 5¬∞ A">
  </div>

  <div class="section">
    <h3>üí™ Fortalezas del Docente</h3>
    <textarea id="fortalezas" placeholder="Describe las principales fortalezas observadas..."></textarea>

    <label style="margin-top: 15px;">‚ö†Ô∏è Aspectos a mejorar</label>
    <textarea id="mejoras" placeholder="Describe los aspectos que el docente puede mejorar..."></textarea>

    <label>üìù Informaci√≥n adicional</label>
    <textarea id="infoExtra" placeholder="Cualquier contexto adicional relevante para el informe..."></textarea>
  </div>

  <button id="generar" class="primary">‚ú® Generar Informe con IA</button>

  <p id="estado" class="status"></p>
</div>

<script>
// Verificar estado de API al cargar
window.onload = function() {
  verificarEstadoApi();
  cargarDocentes();
};

// Funciones de API Key
function verificarEstadoApi() {
  google.script.run
    .withSuccessHandler(function(result) {
      const statusEl = document.getElementById("apiStatus");
      if (result.configurada) {
        statusEl.textContent = "‚úÖ Configurada " + (result.keyParcial || "");
        statusEl.className = "api-status configured";
      } else {
        statusEl.textContent = "‚ùå No configurada";
        statusEl.className = "api-status not-configured";
      }
    })
    .withFailureHandler(function(err) {
      mostrarEstado("estadoApi", "Error al verificar API: " + err.message, "error");
    })
    .verificarApiKey();
}

function mostrarEstado(elementId, mensaje, tipo) {
  const el = document.getElementById(elementId);
  el.textContent = mensaje;
  el.className = "status " + tipo;
  setTimeout(() => {
    el.className = "status";
  }, 5000);
}

document.getElementById("btnGuardarApi").onclick = function() {
  const apiKey = document.getElementById("apiKey").value.trim();
  const modelo = document.getElementById("modeloIA").value;

  if (!apiKey) {
    mostrarEstado("estadoApi", "Por favor ingresa una API Key", "error");
    return;
  }

  mostrarEstado("estadoApi", "Guardando configuraci√≥n...", "info");

  // Guardar API Key
  google.script.run
    .withSuccessHandler(function(result) {
      // Luego guardar modelo
      google.script.run
        .withSuccessHandler(function(result2) {
          mostrarEstado("estadoApi", "‚úÖ Configuraci√≥n guardada correctamente", "success");
          document.getElementById("apiKey").value = "";
          verificarEstadoApi();
        })
        .withFailureHandler(function(err) {
          mostrarEstado("estadoApi", "Error al guardar modelo: " + err.message, "error");
        })
        .guardarModelo(modelo);
    })
    .withFailureHandler(function(err) {
      mostrarEstado("estadoApi", "Error: " + err.message, "error");
    })
    .guardarApiKey(apiKey);
};

document.getElementById("btnProbarApi").onclick = function() {
  mostrarEstado("estadoApi", "Probando conexi√≥n...", "info");

  google.script.run
    .withSuccessHandler(function(result) {
      mostrarEstado("estadoApi", "‚úÖ " + result.message, "success");
    })
    .withFailureHandler(function(err) {
      mostrarEstado("estadoApi", "‚ùå " + err.message, "error");
    })
    .probarConexionGemini();
};

// Cargar docentes
function cargarDocentes() {
  const nivel = document.getElementById("nivel").value;
  const sel = document.getElementById("docente");
  sel.innerHTML = "<option>Cargando...</option>";

  google.script.run
    .withSuccessHandler(function(lista) {
      sel.innerHTML = "<option value=''>Seleccionar...</option>";
      lista.forEach(d => {
        const opt = document.createElement("option");
        opt.value = d.nombre;
        opt.textContent = d.nombre + " ‚Äî " + d.clase;
        sel.appendChild(opt);
      });
    })
    .withFailureHandler(function(err) {
      sel.innerHTML = "<option value=''>Error al cargar</option>";
      mostrarEstado("estado", "Error al cargar docentes: " + err.message, "error");
    })
    .getDocentes(nivel);
}

document.getElementById("nivel").addEventListener("change", cargarDocentes);

// Generar informe
document.getElementById("generar").onclick = function() {
  const nombreDocente = document.getElementById("docente").value;

  if (!nombreDocente) {
    mostrarEstado("estado", "Por favor selecciona un docente", "error");
    return;
  }

  const params = {
    nivel: document.getElementById("nivel").value,
    nombreDocente: nombreDocente,
    grupo: document.getElementById("grupo").value,
    fortalezas: document.getElementById("fortalezas").value,
    mejoras: document.getElementById("mejoras").value,
    infoExtra: document.getElementById("infoExtra").value
  };

  const btnGenerar = document.getElementById("generar");
  btnGenerar.disabled = true;
  btnGenerar.innerHTML = '‚è≥ Generando con IA<span class="loading"></span>';

  const estadoEl = document.getElementById("estado");
  estadoEl.className = "status info";
  estadoEl.textContent = "ü§ñ La IA est√° generando las observaciones personalizadas...";

  google.script.run
    .withSuccessHandler(function(res) {
      btnGenerar.disabled = false;
      btnGenerar.innerHTML = "‚ú® Generar Informe con IA";

      estadoEl.className = "status success";
      estadoEl.innerHTML = `
        ‚úÖ <strong>¬°Informe generado exitosamente!</strong><br>
        <a href="${res.url}" target="_blank" style="color: #137333; font-weight: bold;">
          üìÑ Abrir informe en Google Docs
        </a>
      `;
    })
    .withFailureHandler(function(err) {
      btnGenerar.disabled = false;
      btnGenerar.innerHTML = "‚ú® Generar Informe con IA";

      estadoEl.className = "status error";
      estadoEl.innerHTML = `
        <strong>‚ùå Error:</strong> ${err.message}<br>
        <small>Si el error es sobre API Key, config√∫rala en la secci√≥n de arriba.</small>
      `;
    })
    .generarInforme(params);
};
</script>

</body>
</html>
